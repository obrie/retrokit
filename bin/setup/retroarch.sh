#!/bin/bash

dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"
. "$dir/../common.sh"

setup_module_id='retroarch'
setup_module_desc='Retroarch configuration options'

retroarch_config_path='/opt/retropie/configs/all/retroarch.cfg'
retroarch_default_overlay_path='/opt/retropie/configs/all/retroarch/overlay/base.cfg'

# Re-runs the `configure` action for retroarch
reconfigure_packages() {
  restore
  configure_retropie_package retroarch
  configure
}

configure() {
  __restore_config
  ini_merge '{config_dir}/retroarch/retroarch.cfg' "$retroarch_config_path" restore=false

  # This is our own custom file, so no need to back up
  ini_merge '{config_dir}/retroarch/overlay.cfg' "$retroarch_default_overlay_path" backup=false
}

restore() {
  rm -fv "$retroarch_default_overlay_path"
  __restore_config delete_src=true
}

__restore_config() {
  if has_backup_file "$retroarch_config_path"; then
    if [ -f "$retroarch_config_path" ]; then
      # Keep track inputs generated by the autoconfig
      local retroarch_inputs_path=$(mktemp -p "$tmp_ephemeral_dir")
      grep -E '^input_(player1|state_slot|reset|menu_toggle|load_state|save_state|exit_emulator|enable_hotkey).+' "$retroarch_config_path" | grep -Ev 'gun|mbtn' > "$retroarch_inputs_path"

      restore_file "$retroarch_config_path" "${@}"

      # Merge the inputs back in
      crudini --merge --inplace "$retroarch_config_path" < "$retroarch_inputs_path"
    else
      restore_file "$retroarch_config_path" "${@}"
    fi
  fi
}

setup "${@}"
