#!/bin/bash

dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"
. "$dir/../common.sh"

setup_module_id='retroarch'
setup_module_desc='Retroarch configuration options'

retroarch_config_file="$retropie_configs_dir/all/retroarch.cfg"
retroarch_default_overlay_config_file="$retropie_configs_dir/all/retroarch/overlay/base.cfg"
retroarch_default_overlay_image_file="$retropie_configs_dir/all/retroarch/overlay/base.png"
retroarch_default_overlay_lightgun_config_file="$retropie_configs_dir/all/retroarch/overlay/base-lightgun.cfg"
retroarch_default_overlay_lightgun_image_file="$retropie_configs_dir/all/retroarch/overlay/base-lightgun.png"

# Re-runs the `configure` action for retroarch
reconfigure_packages() {
  restore
  configure_retropie_package retroarch
  configure
}

configure() {
  __restore_config

  __configure_global_overrides
  __configure_shared_overrides
  __configure_overlays
}

__configure_global_overrides() {
  ini_merge '{config_dir}/retroarch/retroarch.cfg' "$retroarch_config_file" restore=false
}

__configure_shared_overrides() {
  while read shared_config_name; do
    ini_merge "{config_dir}/retroarch/$shared_config_name.cfg" "$retropie_configs_dir/all/$shared_config_name.cfg" backup=false
  done < <(each_path '{config_dir}/retroarch' find '{}'  -name 'retroarch-*.cfg' -not -name 'retroarch-core-options*.cfg' -exec basename {} .cfg \; | sort | uniq)
}

__configure_overlays() {
  # These are our own custom file, so no need to back up
  ini_merge '{config_dir}/retroarch/overlay.cfg' "$retroarch_default_overlay_config_file" backup=false
  file_cp '{config_dir}/retroarch/overlay.png' "$retroarch_default_overlay_image_file" backup=false

  ini_merge '{config_dir}/retroarch/overlay-lightgun.cfg' "$retroarch_default_overlay_lightgun_config_file" backup=false
  file_cp '{config_dir}/retroarch/overlay-lightgun.png' "$retroarch_default_overlay_lightgun_image_file" backup=false
}

restore() {
  rm -fv \
    "$retroarch_default_overlay_config_file" \
    "$retroarch_default_overlay_lightgun_config_file" \
    "$retroarch_default_overlay_image_file" \
    "$retroarch_default_overlay_lightgun_image_file"

  find "$retropie_configs_dir/all" -mindepth 1 -maxdepth 1 -name 'retroarch-*.cfg' -not -name 'retroarch-core-options*.cfg' -exec rm -fv '{}' +

  __restore_config delete_src=true
}

__restore_config() {
  if has_backup_file "$retroarch_config_file"; then
    if [ -f "$retroarch_config_file" ]; then
      # Keep track inputs generated by the autoconfig
      local retroarch_inputs_file=$(mktemp -p "$tmp_ephemeral_dir")
      grep -E '^input_(player1|state_slot|reset|menu_toggle|load_state|save_state|exit_emulator|enable_hotkey).+' "$retroarch_config_file" | grep -Ev 'gun|mbtn' > "$retroarch_inputs_file"

      restore_file "$retroarch_config_file" "${@}"

      # Merge the inputs back in
      crudini --merge --inplace "$retroarch_config_file" < "$retroarch_inputs_file"
    else
      restore_file "$retroarch_config_file" "${@}"
    fi
  fi
}

setup "${@}"
